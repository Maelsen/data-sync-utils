// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL") // Uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // Uses a direct connection
}

// Multi-PMS support: Mews, HotelSpider, etc.
enum PmsType {
  mews
  hotelspider
}

model Hotel {
  id          String   @id @default(uuid())
  mewsId      String   @unique // DEPRECATED: Use externalId - kept for backward compatibility
  name        String
  pmsType     PmsType  @default(mews) // PMS system type
  externalId  String?  // Generic external ID (Mews enterprise ID, HotelSpider hotel code, etc.)
  orders      TreeOrder[]
  invoices    Invoice[]
  config      HotelConfig?
  credentials HotelCredentials? // NEW: Encrypted per-hotel credentials
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([pmsType, externalId])
  @@index([pmsType])
}

model TreeOrder {
  id          String   @id @default(uuid())
  mewsId      String   @unique // External ID from PMS (prefixed with pmsType, e.g., "mews-123", "hotelspider-456")
  hotelId     String
  hotel       Hotel    @relation(fields: [hotelId], references: [id])
  pmsType     PmsType  @default(mews) // Which PMS this order came from
  quantity    Int
  amount      Float
  currency    String
  createdAt   DateTime @default(now())
  bookedAt        DateTime // When it was booked in the PMS
  checkInAt       DateTime? // Scheduled check-in date (ScheduledStartUtc) - planned arrival
  actualCheckInAt DateTime? // Actual check-in date (ActualStartUtc) - confirmed arrival, use for invoicing

  @@index([hotelId, bookedAt])
  @@index([actualCheckInAt]) // Index for invoice filtering by confirmed arrivals
  @@index([pmsType, hotelId])
  @@index([checkInAt]) // Index for filtering by check-in date
}

model Invoice {
  id          String   @id @default(uuid())
  hotelId     String
  hotel       Hotel    @relation(fields: [hotelId], references: [id])
  month       Int
  year        Int
  totalTrees  Int
  totalAmount Float
  pdfPath     String
  createdAt   DateTime @default(now())
  
  @@unique([hotelId, month, year])
  @@index([hotelId, year, month])
}

// NEW: Webhook events for audit trail and PMS certification
model WebhookEvent {
  id          String   @id @default(uuid())
  eventType   String   // ServiceOrderCreated, OTA_HotelResNotifRQ, etc.
  eventId     String?  @unique // PMS event ID for deduplication
  pmsType     PmsType  @default(mews) // Which PMS this webhook came from
  hotelId     String?  // Associated hotel (if identifiable)
  payload     Json     // Full webhook payload data
  processed   Boolean  @default(false)
  processedAt DateTime?
  error       String?
  retryCount  Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([processed, createdAt])
  @@index([eventType, createdAt])
  @@index([pmsType, hotelId])
}

// NEW: Hotel configuration for multi-tenant support
model HotelConfig {
  id              String   @id @default(uuid())
  hotelId         String   @unique
  hotel           Hotel    @relation(fields: [hotelId], references: [id])
  mewsAccessToken String   // DEPRECATED: Use HotelCredentials instead
  webhookEnabled  Boolean  @default(true)
  syncFrequency   String   @default("daily") // hourly, daily, webhook-only
  active          Boolean  @default(true)
  lastSyncAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// NEW: Encrypted per-hotel credentials for multi-PMS support
model HotelCredentials {
  id              String   @id @default(uuid())
  hotelId         String   @unique
  hotel           Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Mews-specific credentials (encrypted)
  mewsClientToken String?  // Encrypted Mews client token
  mewsAccessToken String?  // Encrypted Mews access token

  // HotelSpider-specific credentials (encrypted)
  hotelspiderUsername String?  // Encrypted username
  hotelspiderPassword String?  // Encrypted password
  hotelspiderHotelCode String?  // Plain text hotel identifier

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// NEW: API call logging for Mews certification review
model ApiLog {
  id          String   @id @default(uuid())
  timestamp   DateTime @default(now())
  endpoint    String   // e.g., /api/connector/v1/orders/getAll
  method      String   // GET, POST
  statusCode  Int      // 200, 500, etc.
  duration    Int      // milliseconds
  hotelId     String?
  success     Boolean
  error       String?
  metadata    Json?    // request/response details
  
  @@index([timestamp])
  @@index([hotelId, timestamp])
  @@index([success, timestamp])
}

// NEW: System health tracking
model SystemHealth {
  id              String   @id @default(uuid())
  timestamp       DateTime @default(now())
  component       String   // database, mews-api, blob-storage
  status          String   // healthy, degraded, down
  responseTime    Int?     // milliseconds
  errorMessage    String?
  metadata        Json?
  
  @@index([component, timestamp])
}
